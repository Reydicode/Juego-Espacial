<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Duelo Espacial Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(to bottom, #000000, #0a0a2e, #16213e);
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            max-height: 800px;
        }

        @media (max-width: 768px) {
            #gameContainer {
                max-width: 100vw;
                max-height: 100vh;
            }
        }

        #gameCanvas {
            background: radial-gradient(circle at 50% 50%, #0f0f23, #000000);
            border: 3px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            display: block;
            width: 100%;
            height: 100%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10;
        }

        .screen.active {
            display: flex;
        }

        h1 {
            font-size: 4rem;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
                margin-bottom: 15px;
            }
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff; }
            50% { text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff, 0 0 80px #00ffff; }
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #00ffff;
            color: white;
            padding: 15px 40px;
            font-size: 1.3rem;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            -webkit-tap-highlight-color: transparent;
        }

        button:hover, button:active {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        @media (max-width: 768px) {
            button {
                padding: 12px 30px;
                font-size: 1.1rem;
                margin: 8px;
            }
        }

        @media (max-width: 480px) {
            button {
                padding: 10px 25px;
                font-size: 1rem;
                margin: 6px;
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        input {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffff;
            color: white;
            padding: 12px 20px;
            font-size: 1.1rem;
            margin: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            width: 300px;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            input {
                width: 80%;
                max-width: 300px;
                font-size: 1rem;
                padding: 10px 15px;
            }
        }

        @media (max-width: 480px) {
            input {
                width: 90%;
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }

        .difficulty-selector {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .difficulty-btn {
            padding: 10px 25px;
            font-size: 1rem;
        }

        .difficulty-btn.easy { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .difficulty-btn.medium { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
        .difficulty-btn.hard { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

        #hud {
            position: absolute;
            top: 20px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 5;
        }

        #hud.active {
            display: flex;
        }

        .player-stats {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
            min-width: 250px;
        }

        .player-stats.p1 { border-color: #00ffff; }
        .player-stats.p2 { border-color: #ff00ff; }

        .stat-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .health-bar {
            width: 100%;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid white;
        }

        .health-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .p1 .health-fill {
            background: linear-gradient(90deg, #00ffff, #00aaff);
        }

        .p2 .health-fill {
            background: linear-gradient(90deg, #ff00ff, #ff00aa);
        }

        .score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 0 0 10px #ffff00;
        }

        #centerInfo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 6;
            font-size: 2rem;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
            display: none;
        }

        #centerInfo.active {
            display: block;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        .controls-info {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #aaaaaa;
            text-align: center;
        }

        .controls-info p {
            margin: 5px 0;
        }

        #leaderboard {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            margin-top: 20px;
            max-width: 400px;
        }

        #leaderboard h3 {
            color: #00ffff;
            margin-bottom: 15px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .room-code-display {
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .room-code-display h3 {
            color: #ffff00;
            margin-bottom: 10px;
        }

        .room-code-display .code {
            font-size: 2rem;
            color: #00ffff;
            font-weight: bold;
            letter-spacing: 5px;
            text-shadow: 0 0 10px #00ffff;
        }

        .waiting-message {
            color: #ffaa00;
            font-size: 1.2rem;
            margin-top: 15px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse-dot 1.5s infinite;
        }

        .status-indicator.online {
            background: #00ff00;
        }

        .status-indicator.offline {
            background: #ff0000;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .info-box {
            background: rgba(255, 255, 0, 0.1);
            border: 2px solid #ffff00;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-width: 500px;
            text-align: left;
        }

        .info-box h4 {
            color: #ffff00;
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style-position: inside;
            color: #aaaaaa;
        }

        .copy-btn {
            padding: 8px 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* ========== CONTROLES T√ÅCTILES M√ìVILES ========== */
        #mobileControls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 20;
            pointer-events: none;
        }

        #mobileControls.active {
            display: flex;
        }

        .joystick-container {
            width: 120px;
            height: 120px;
            position: relative;
            pointer-events: all;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(0, 255, 255, 0.2);
            border: 3px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
        }

        .joystick-stick {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #00ffff, #0088ff);
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .shoot-button {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ff0066, #cc0044);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.8);
            pointer-events: all;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .shoot-button:active {
            transform: scale(0.9);
            box-shadow: 0 0 30px rgba(255, 0, 102, 1);
        }

        @media (min-width: 769px) {
            #mobileControls {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .controls-info {
                font-size: 0.8rem;
            }
            
            .player-stats {
                min-width: 180px;
                padding: 10px;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .score {
                font-size: 1.2rem;
            }
            
            .health-bar {
                height: 20px;
            }
        }

        @media (max-width: 480px) {
            #hud {
                padding: 0 10px;
                top: 10px;
            }
            
            .player-stats {
                min-width: 140px;
                padding: 8px;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
            
            .score {
                font-size: 1rem;
            }
            
            .health-bar {
                height: 15px;
            }
            
            .joystick-container {
                width: 100px;
                height: 100px;
            }
            
            .joystick-stick {
                width: 40px;
                height: 40px;
            }
            
            .shoot-button {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Pantalla de Inicio -->
        <div id="menuScreen" class="screen active">
            <h1>üöÄ DUELO ESPACIAL</h1>
            <button onclick="game.selectMode('ai')">ü§ñ VS M√ÅQUINA</button>
            <button onclick="game.selectMode('online')">üåê MULTIJUGADOR ONLINE</button>
            <button onclick="game.selectMode('local')">üë• 2 JUGADORES (LOCAL)</button>
            <div id="leaderboard"></div>
            <div class="controls-info">
                <p><strong>CONTROLES:</strong> W/A/S/D = Mover | ESPACIO = Disparar</p>
                <p><strong>PAUSA:</strong> P</p>
            </div>
        </div>

        <!-- Pantalla de Multijugador Online -->
        <div id="onlineScreen" class="screen">
            <h1>üåê MULTIJUGADOR ONLINE</h1>
            <button onclick="game.showCreateRoom()">CREAR SALA</button>
            <button onclick="game.showJoinRoom()">UNIRSE A SALA</button>
            <button onclick="game.backToMenu()">VOLVER</button>
            
            <div class="info-box">
                <h4>‚ÑπÔ∏è C√≥mo funciona:</h4>
                <ul>
                    <li>Un jugador crea una sala y obtiene un c√≥digo</li>
                    <li>Comparte el c√≥digo con tu amigo</li>
                    <li>Tu amigo se une usando ese c√≥digo</li>
                    <li>¬°Jueguen en tiempo real desde diferentes computadoras!</li>
                </ul>
            </div>
        </div>

        <!-- Crear Sala -->
        <div id="createRoomScreen" class="screen">
            <h1>CREAR SALA</h1>
            <input type="text" id="hostName" placeholder="Tu nombre" maxlength="15">
            <button onclick="game.createRoom()" id="createRoomBtn">CREAR SALA</button>
            <button onclick="game.showOnlineMenu()">VOLVER</button>
            
            <div id="roomCreated" style="display: none;">
                <div class="room-code-display">
                    <h3>C√ìDIGO DE SALA:</h3>
                    <div class="code" id="roomCodeDisplay"></div>
                    <button class="copy-btn" onclick="game.copyRoomCode()">üìã COPIAR C√ìDIGO</button>
                </div>
                <div class="waiting-message">
                    ‚è≥ Esperando a que se una el otro jugador...
                    <span class="status-indicator online"></span>
                </div>
            </div>
        </div>

        <!-- Unirse a Sala -->
        <div id="joinRoomScreen" class="screen">
            <h1>UNIRSE A SALA</h1>
            <input type="text" id="playerName" placeholder="Tu nombre" maxlength="15">
            <input type="text" id="roomCodeInput" placeholder="C√≥digo de sala" maxlength="6">
            <button onclick="game.joinRoom()" id="joinRoomBtn">UNIRSE</button>
            <button onclick="game.showOnlineMenu()">VOLVER</button>
            
            <div id="joinStatus" style="margin-top: 20px; color: #ffaa00;"></div>
        </div>

        <!-- Selecci√≥n de Dificultad (IA) -->
        <div id="difficultyScreen" class="screen">
            <h1>SELECCIONA DIFICULTAD</h1>
            <div class="difficulty-selector">
                <button class="difficulty-btn easy" onclick="game.startGame('easy')">F√ÅCIL</button>
                <button class="difficulty-btn medium" onclick="game.startGame('medium')">MEDIO</button>
                <button class="difficulty-btn hard" onclick="game.startGame('hard')">DIF√çCIL</button>
            </div>
            <button onclick="game.backToMenu()">VOLVER</button>
        </div>

        <!-- Pantalla de Pausa -->
        <div id="pauseScreen" class="screen">
            <h1>‚è∏ PAUSA</h1>
            <button onclick="game.resume()">CONTINUAR</button>
            <button onclick="game.backToMenu()">MEN√ö PRINCIPAL</button>
        </div>

        <!-- Pantalla de Game Over -->
        <div id="gameOverScreen" class="screen">
            <h1 id="gameOverTitle">GAME OVER</h1>
            <p id="gameOverMessage" style="font-size: 1.5rem; margin: 20px 0;"></p>
            <p id="finalScore" style="font-size: 1.2rem; color: #ffff00;"></p>
            <button onclick="game.restart()">JUGAR DE NUEVO</button>
            <button onclick="game.backToMenu()">MEN√ö PRINCIPAL</button>
        </div>

        <!-- HUD del Juego -->
        <div id="hud">
            <div class="player-stats p1">
                <div class="stat-label" id="p1NameLabel">JUGADOR 1</div>
                <div class="health-bar">
                    <div class="health-fill" id="p1Health" style="width: 100%"></div>
                </div>
                <div class="score">PUNTOS: <span id="p1Score">0</span></div>
                <div class="stat-label">NIVEL: <span id="level">1</span></div>
            </div>
            <div class="player-stats p2">
                <div class="stat-label" id="p2Label">JUGADOR 2</div>
                <div class="health-bar">
                    <div class="health-fill" id="p2Health" style="width: 100%"></div>
                </div>
                <div class="score">PUNTOS: <span id="p2Score">0</span></div>
                <div class="stat-label">TIEMPO: <span id="timer">0</span>s</div>
            </div>
        </div>

        <div id="centerInfo"></div>

        <!-- Controles M√≥viles -->
        <div id="mobileControls">
            <div class="joystick-container" id="joystick">
                <div class="joystick-base"></div>
                <div class="joystick-stick" id="joystickStick"></div>
            </div>
            <div class="shoot-button" id="shootButton">üî•</div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ========== CLASES DEL JUEGO ==========

        class Ship {
            constructor(x, y, color, isPlayer1) {
                this.x = x;
                this.y = y;
                this.width = 40;
                this.height = 50;
                this.color = color;
                this.health = 100;
                this.maxHealth = 100;
                this.speed = 5;
                this.bullets = [];
                this.score = 0;
                this.isPlayer1 = isPlayer1;
                this.shootCooldown = 0;
                this.maxCooldown = 20;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(0, -this.height/2);
                ctx.lineTo(-this.width/2, this.height/2);
                ctx.lineTo(0, this.height/3);
                ctx.lineTo(this.width/2, this.height/2);
                ctx.closePath();
                ctx.fill();
                
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                if (Math.random() > 0.5) {
                    ctx.fillStyle = '#ffaa00';
                    ctx.fillRect(-10, this.height/2, 8, 10);
                    ctx.fillRect(2, this.height/2, 8, 10);
                }
                
                ctx.restore();

                this.bullets.forEach(bullet => bullet.draw());
            }

            shoot() {
                if (this.shootCooldown <= 0) {
                    this.bullets.push(new Bullet(this.x, this.y - this.height/2, this.color, this.isPlayer1));
                    this.shootCooldown = this.maxCooldown;
                }
            }

            update() {
                if (this.shootCooldown > 0) this.shootCooldown--;

                this.bullets = this.bullets.filter(bullet => {
                    bullet.update();
                    return bullet.active;
                });

                this.x = Math.max(this.width/2, Math.min(canvas.width - this.width/2, this.x));
                this.y = Math.max(this.height/2, Math.min(canvas.height - this.height/2, this.y));
            }

            takeDamage(amount) {
                this.health -= amount;
                if (this.health < 0) this.health = 0;
                this.createDamageEffect();
            }

            createDamageEffect() {
                for (let i = 0; i < 10; i++) {
                    game.particles.push({
                        x: this.x,
                        y: this.y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        life: 30,
                        color: this.color
                    });
                }
            }

            getState() {
                return {
                    x: this.x,
                    y: this.y,
                    health: this.health,
                    score: this.score,
                    bullets: this.bullets.map(b => ({ x: b.x, y: b.y, active: b.active }))
                };
            }

            setState(state) {
                this.x = state.x;
                this.y = state.y;
                this.health = state.health;
                this.score = state.score;
            }
        }

        class Bullet {
            constructor(x, y, color, movingUp) {
                this.x = x;
                this.y = y;
                this.width = 4;
                this.height = 15;
                this.color = color;
                this.speed = movingUp ? -10 : 10;
                this.active = true;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = this.color;
                ctx.fillRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height);
                ctx.shadowBlur = 0;
            }

            update() {
                this.y += this.speed;
                if (this.y < 0 || this.y > canvas.height) {
                    this.active = false;
                }
            }
        }

        class AI {
            constructor(ship, difficulty) {
                this.ship = ship;
                this.difficulty = difficulty;
                this.targetX = ship.x;
                this.updateDelay = 0;
                this.shootDelay = 0;
                
                const configs = {
                    easy: { updateSpeed: 30, shootChance: 0.02, dodgeSkill: 0.3, accuracy: 0.5 },
                    medium: { updateSpeed: 20, shootChance: 0.04, dodgeSkill: 0.6, accuracy: 0.7 },
                    hard: { updateSpeed: 10, shootChance: 0.06, dodgeSkill: 0.9, accuracy: 0.9 }
                };
                
                this.config = configs[difficulty];
            }

            update(player) {
                this.updateDelay++;
                this.shootDelay++;

                if (this.updateDelay >= this.config.updateSpeed) {
                    this.updateDelay = 0;
                    this.decideAction(player);
                }

                const dx = this.targetX - this.ship.x;
                if (Math.abs(dx) > 5) {
                    this.ship.x += Math.sign(dx) * this.ship.speed * 0.7;
                }

                if (this.shootDelay > 40 && Math.random() < this.config.shootChance) {
                    this.ship.shoot();
                    this.shootDelay = 0;
                }
            }

            decideAction(player) {
                const dangerousBullets = player.bullets.filter(b => 
                    Math.abs(b.x - this.ship.x) < 80 && 
                    Math.abs(b.y - this.ship.y) < 200
                );

                if (dangerousBullets.length > 0 && Math.random() < this.config.dodgeSkill) {
                    const bullet = dangerousBullets[0];
                    this.targetX = bullet.x < this.ship.x ? 
                        this.ship.x + 150 : this.ship.x - 150;
                } else {
                    const offset = (Math.random() - 0.5) * 200 * (1 - this.config.accuracy);
                    this.targetX = player.x + offset;
                }

                this.targetX = Math.max(50, Math.min(canvas.width - 50, this.targetX));
            }
        }

        // ========== SISTEMA MULTIJUGADOR CON PERSISTENT STORAGE ==========
        
        class MultiplayerManager {
            constructor() {
                this.roomCode = null;
                this.isHost = false;
                this.playerName = '';
                this.opponentName = '';
                this.syncInterval = null;
                this.checkInterval = null;
            }

            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            async createRoom(hostName) {
                this.roomCode = this.generateRoomCode();
                this.isHost = true;
                this.playerName = hostName;
                
                try {
                    // Crear sala en persistent storage (compartido entre usuarios)
                    const roomData = {
                        host: hostName,
                        guest: null,
                        gameState: null,
                        status: 'waiting',
                        createdAt: Date.now()
                    };
                    
                    await window.storage.set(`room:${this.roomCode}`, JSON.stringify(roomData), true);
                    
                    // Verificar peri√≥dicamente si alguien se uni√≥
                    this.checkForOpponent();
                    
                    return this.roomCode;
                } catch (error) {
                    console.error('Error creando sala:', error);
                    throw error;
                }
            }

            async checkForOpponent() {
                this.checkInterval = setInterval(async () => {
                    try {
                        const result = await window.storage.get(`room:${this.roomCode}`, true);
                        if (result && result.value) {
                            const room = JSON.parse(result.value);
                            if (room.guest) {
                                this.opponentName = room.guest;
                                clearInterval(this.checkInterval);
                                game.startOnlineGame();
                            }
                        }
                    } catch (error) {
                        console.error('Error verificando oponente:', error);
                    }
                }, 1000);
            }

            async joinRoom(roomCode, playerName) {
                try {
                    const result = await window.storage.get(`room:${roomCode}`, true);
                    
                    if (!result || !result.value) {
                        return { success: false, message: 'Sala no encontrada' };
                    }
                    
                    const room = JSON.parse(result.value);
                    
                    if (room.guest) {
                        return { success: false, message: 'La sala est√° llena' };
                    }
                    
                    this.roomCode = roomCode;
                    this.isHost = false;
                    this.playerName = playerName;
                    this.opponentName = room.host;
                    
                    // Unirse a la sala
                    room.guest = playerName;
                    room.status = 'playing';
                    
                    await window.storage.set(`room:${roomCode}`, JSON.stringify(room), true);
                    
                    return { success: true, hostName: room.host };
                } catch (error) {
                    console.error('Error uni√©ndose a sala:', error);
                    return { success: false, message: 'Error al conectar' };
                }
            }

            startSync() {
                this.syncInterval = setInterval(() => {
                    this.syncGameState();
                }, 100); // Sincronizar cada 100ms
            }

            async syncGameState() {
                if (!game.player1 || !game.player2) return;
                
                try {
                    if (this.isHost) {
                        // El host env√≠a el estado completo del juego
                        const gameState = {
                            p1: game.player1.getState(),
                            p2: game.player2.getState(),
                            level: game.level,
                            timer: game.timer,
                            timestamp: Date.now()
                        };
                        
                        await window.storage.set(`game:${this.roomCode}`, JSON.stringify(gameState), true);
                    } else {
                        // El invitado lee el estado del host
                        const result = await window.storage.get(`game:${this.roomCode}`, true);
                        if (result && result.value) {
                            const gameState = JSON.parse(result.value);
                            
                            // Actualizar estado del oponente (invertir perspectiva)
                            game.player2.setState(gameState.p1);
                            game.level = gameState.level;
                            game.timer = gameState.timer;
                        }
                        
                        // El invitado env√≠a su propio estado
                        const myState = {
                            p2State: game.player1.getState(),
                            timestamp: Date.now()
                        };
                        await window.storage.set(`player:${this.roomCode}:guest`, JSON.stringify(myState), true);
                    }
                    
                    // Si soy host, leer el estado del invitado
                    if (this.isHost) {
                        const guestResult = await window.storage.get(`player:${this.roomCode}:guest`, true);
                        if (guestResult && guestResult.value) {
                            const guestState = JSON.parse(guestResult.value);
                            game.player2.setState(guestState.p2State);
                        }
                    }
                } catch (error) {
                    console.error('Error sincronizando:', error);
                }
            }

            async sendAction(action) {
                try {
                    const actionKey = `action:${this.roomCode}:${this.isHost ? 'host' : 'guest'}:${Date.now()}`;
                    await window.storage.set(actionKey, JSON.stringify({
                        player: this.isHost ? 'host' : 'guest',
                        action: action,
                        timestamp: Date.now()
                    }), true);
                } catch (error) {
                    console.error('Error enviando acci√≥n:', error);
                }
            }

            stopSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
            }

            async cleanup() {
                this.stopSync();
                
                // Limpiar datos de la sala
                if (this.roomCode) {
                    try {
                        await window.storage.delete(`room:${this.roomCode}`, true);
                        await window.storage.delete(`game:${this.roomCode}`, true);
                        await window.storage.delete(`player:${this.roomCode}:guest`, true);
                    } catch (error) {
                        console.error('Error limpiando sala:', error);
                    }
                }
                
                this.roomCode = null;
                this.isHost = false;
            }
        }

        // ========== JUEGO PRINCIPAL ==========
        const game = {
            state: 'menu',
            mode: null,
            difficulty: null,
            player1: null,
            player2: null,
            ai: null,
            keys: {},
            level: 1,
            timer: 0,
            timerInterval: null,
            particles: [],
            stars: [],
            leaderboard: [],
            multiplayer: new MultiplayerManager(),
            // Controles m√≥viles
            joystick: {
                active: false,
                x: 0,
                y: 0,
                startX: 0,
                startY: 0
            },
            isMobile: false,

            init() {
                this.createStars();
                this.loadLeaderboard();
                this.updateLeaderboardDisplay();
                this.detectMobile();
                this.setupMobileControls();
                
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    
                    if (e.key === 'p' && this.state === 'playing') {
                        this.pause();
                    }
                    if (e.key === ' ' && this.state === 'playing') {
                        e.preventDefault();
                        if (this.mode === 'online') {
                            this.multiplayer.sendAction('shoot');
                        }
                        this.player1.shoot();
                    }
                    if (e.key === 'Enter' && this.state === 'playing' && this.mode === 'local') {
                        e.preventDefault();
                        this.player2.shoot();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });
            },

            detectMobile() {
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                    || window.innerWidth <= 768;
            },

            setupMobileControls() {
                const joystick = document.getElementById('joystick');
                const joystickStick = document.getElementById('joystickStick');
                const shootButton = document.getElementById('shootButton');

                // Joystick touch events
                joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.state !== 'playing') return;
                    
                    const touch = e.touches[0];
                    const rect = joystick.getBoundingClientRect();
                    this.joystick.startX = rect.left + rect.width / 2;
                    this.joystick.startY = rect.top + rect.height / 2;
                    this.joystick.active = true;
                    this.updateJoystick(touch.clientX, touch.clientY, joystickStick);
                });

                joystick.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (!this.joystick.active || this.state !== 'playing') return;
                    const touch = e.touches[0];
                    this.updateJoystick(touch.clientX, touch.clientY, joystickStick);
                });

                joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.joystick.active = false;
                    this.joystick.x = 0;
                    this.joystick.y = 0;
                    joystickStick.style.transform = 'translate(-50%, -50%)';
                });

                // Shoot button
                shootButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.state !== 'playing' || !this.player1) return;
                    
                    if (this.mode === 'online') {
                        this.multiplayer.sendAction('shoot');
                    }
                    this.player1.shoot();
                });

                // Prevenir scroll en m√≥vil durante el juego
                document.body.addEventListener('touchmove', (e) => {
                    if (this.state === 'playing') {
                        e.preventDefault();
                    }
                }, { passive: false });
            },

            updateJoystick(touchX, touchY, stick) {
                const maxDistance = 50;
                let dx = touchX - this.joystick.startX;
                let dy = touchY - this.joystick.startY;
                
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > maxDistance) {
                    dx = (dx / distance) * maxDistance;
                    dy = (dy / distance) * maxDistance;
                }
                
                this.joystick.x = dx / maxDistance;
                this.joystick.y = dy / maxDistance;
                
                stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            },

            createStars() {
                for (let i = 0; i < 150; i++) {
                    this.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2,
                        speed: Math.random() * 0.5 + 0.2,
                        opacity: Math.random()
                    });
                }
            },

            selectMode(mode) {
                this.mode = mode;
                document.getElementById('menuScreen').classList.remove('active');
                
                if (mode === 'ai') {
                    document.getElementById('difficultyScreen').classList.add('active');
                } else if (mode === 'online') {
                    document.getElementById('onlineScreen').classList.add('active');
                } else {
                    this.startGame(null);
                }
            },

            showOnlineMenu() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('onlineScreen').classList.add('active');
            },

            showCreateRoom() {
                document.getElementById('onlineScreen').classList.remove('active');
                document.getElementById('createRoomScreen').classList.add('active');
                document.getElementById('roomCreated').style.display = 'none';
            },

            showJoinRoom() {
                document.getElementById('onlineScreen').classList.remove('active');
                document.getElementById('joinRoomScreen').classList.add('active');
                document.getElementById('joinStatus').textContent = '';
            },

            async createRoom() {
                const hostName = document.getElementById('hostName').value.trim();
                
                if (!hostName) {
                    alert('Por favor ingresa tu nombre');
                    return;
                }
                
                document.getElementById('createRoomBtn').disabled = true;
                document.getElementById('createRoomBtn').textContent = 'CREANDO...';
                
                try {
                    const roomCode = await this.multiplayer.createRoom(hostName);
                    
                    document.getElementById('roomCodeDisplay').textContent = roomCode;
                    document.getElementById('roomCreated').style.display = 'block';
                    
                    this.showMessage('Sala creada exitosamente');
                } catch (error) {
                    alert('Error al crear sala. Intenta de nuevo.');
                    document.getElementById('createRoomBtn').disabled = false;
                    document.getElementById('createRoomBtn').textContent = 'CREAR SALA';
                }
            },

            copyRoomCode() {
                const code = document.getElementById('roomCodeDisplay').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    this.showMessage('¬°C√≥digo copiado al portapapeles!');
                });
            },

            async joinRoom() {
                const playerName = document.getElementById('playerName').value.trim();
                const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
                
                if (!playerName || !roomCode) {
                    document.getElementById('joinStatus').textContent = '‚ö†Ô∏è Completa todos los campos';
                    return;
                }
                
                document.getElementById('joinRoomBtn').disabled = true;
                document.getElementById('joinStatus').textContent = 'üîÑ Conectando...';
                
                const result = await this.multiplayer.joinRoom(roomCode, playerName);
                
                if (result.success) {
                    document.getElementById('joinStatus').textContent = `‚úÖ Conectado con ${result.hostName}`;
                    setTimeout(() => this.startOnlineGame(), 1000);
                } else {
                    document.getElementById('joinStatus').textContent = `‚ùå ${result.message}`;
                    document.getElementById('joinRoomBtn').disabled = false;
                }
            },

            startOnlineGame() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                
                const isHost = this.multiplayer.isHost;
                const p1Name = this.multiplayer.playerName;
                const p2Name = this.multiplayer.opponentName;
                
                document.getElementById('p1NameLabel').textContent = p1Name;
                document.getElementById('p2Label').textContent = p2Name;
                
                this.startGame(null, true);
                this.multiplayer.startSync();
                
                this.showMessage(`¬°Conectado! VS ${p2Name}`);
            },

            startGame(difficulty, isOnline = false) {
                this.difficulty = difficulty;
                this.state = 'playing';
                this.level = 1;
                this.timer = 0;
                this.particles = [];
                
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('hud').classList.add('active');
                
                // Mostrar controles m√≥viles si es necesario
                if (this.isMobile) {
                    document.getElementById('mobileControls').classList.add('active');
                }
                
                this.player1 = new Ship(canvas.width / 2, canvas.height - 100, '#00ffff', true);
                
                if (this.mode === 'ai') {
                    this.player2 = new Ship(canvas.width / 2, 100, '#ff00ff', false);
                    this.ai = new AI(this.player2, difficulty);
                    document.getElementById('p2Label').textContent = 'ü§ñ M√ÅQUINA';
                } else if (this.mode === 'online') {
                    this.player2 = new Ship(canvas.width / 2, 100, '#ff00ff', false);
                } else {
                    this.player2 = new Ship(canvas.width / 2, 100, '#ff00ff', false);
                    document.getElementById('p2Label').textContent = 'JUGADOR 2';
                }
                
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    document.getElementById('timer').textContent = this.timer;
                    
                    if (this.timer % 30 === 0) {
                        this.levelUp();
                    }
                }, 1000);
                
                this.gameLoop();
            },

            levelUp() {
                this.level++;
                document.getElementById('level').textContent = this.level;
                
                this.player1.speed += 0.5;
                this.player2.speed += 0.5;
                this.player1.maxCooldown = Math.max(10, this.player1.maxCooldown - 2);
                this.player2.maxCooldown = Math.max(10, this.player2.maxCooldown - 2);
                
                this.showMessage(`¬°NIVEL ${this.level}!`);
                
                for (let i = 0; i < 50; i++) {
                    this.particles.push({
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15,
                        life: 60,
                        color: '#ffff00'
                    });
                }
            },

            showMessage(text) {
                const msg = document.getElementById('centerInfo');
                msg.textContent = text;
                msg.classList.add('active');
                setTimeout(() => msg.classList.remove('active'), 2000);
            },

            gameLoop() {
                if (this.state !== 'playing') return;
                
                this.update();
                this.draw();
                
                requestAnimationFrame(() => this.gameLoop());
            },

            update() {
                this.stars.forEach(star => {
                    star.y += star.speed;
                    if (star.y > canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * canvas.width;
                    }
                });

                // Controles de teclado para Player 1
                if (this.keys['w']) this.player1.y -= this.player1.speed;
                if (this.keys['s']) this.player1.y += this.player1.speed;
                if (this.keys['a']) this.player1.x -= this.player1.speed;
                if (this.keys['d']) this.player1.x += this.player1.speed;
                
                // Controles t√°ctiles para Player 1 (m√≥vil)
                if (this.isMobile && this.joystick.active) {
                    this.player1.x += this.joystick.x * this.player1.speed;
                    this.player1.y += this.joystick.y * this.player1.speed;
                }
                
                if (this.mode === 'local') {
                    if (this.keys['arrowup']) this.player2.y -= this.player2.speed;
                    if (this.keys['arrowdown']) this.player2.y += this.player2.speed;
                    if (this.keys['arrowleft']) this.player2.x -= this.player2.speed;
                    if (this.keys['arrowright']) this.player2.x += this.player2.speed;
                } else if (this.ai) {
                    this.ai.update(this.player1);
                }
                
                this.player1.update();
                this.player2.update();
                
                this.checkCollisions();
                
                this.particles = this.particles.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    return p.life > 0;
                });
                
                this.updateHUD();
                
                if (this.player1.health <= 0 || this.player2.health <= 0) {
                    this.endGame();
                }
            },

            checkCollisions() {
                this.player1.bullets.forEach(bullet => {
                    if (this.checkBulletShipCollision(bullet, this.player2)) {
                        bullet.active = false;
                        this.player2.takeDamage(10);
                        this.player1.score += 10;
                    }
                });
                
                this.player2.bullets.forEach(bullet => {
                    if (this.checkBulletShipCollision(bullet, this.player1)) {
                        bullet.active = false;
                        this.player1.takeDamage(10);
                        this.player2.score += 10;
                    }
                });
            },

            checkBulletShipCollision(bullet, ship) {
                return bullet.active &&
                    bullet.x > ship.x - ship.width/2 &&
                    bullet.x < ship.x + ship.width/2 &&
                    bullet.y > ship.y - ship.height/2 &&
                    bullet.y < ship.y + ship.height/2;
            },

            draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                this.stars.forEach(star => {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fillRect(star.x, star.y, star.size, star.size);
                });
                
                this.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 60;
                    ctx.fillRect(p.x, p.y, 3, 3);
                    ctx.globalAlpha = 1;
                });
                
                this.player1.draw();
                this.player2.draw();
            },

            updateHUD() {
                document.getElementById('p1Health').style.width = this.player1.health + '%';
                document.getElementById('p2Health').style.width = this.player2.health + '%';
                document.getElementById('p1Score').textContent = this.player1.score;
                document.getElementById('p2Score').textContent = this.player2.score;
            },

            pause() {
                this.state = 'paused';
                document.getElementById('pauseScreen').classList.add('active');
                clearInterval(this.timerInterval);
            },

            resume() {
                this.state = 'playing';
                document.getElementById('pauseScreen').classList.remove('active');
                
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    document.getElementById('timer').textContent = this.timer;
                    if (this.timer % 30 === 0) this.levelUp();
                }, 1000);
                
                this.gameLoop();
            },

            endGame() {
                this.state = 'gameover';
                clearInterval(this.timerInterval);
                
                if (this.mode === 'online') {
                    this.multiplayer.cleanup();
                }
                
                const winner = this.player1.health > 0 ? 'player1' : 'player2';
                const winnerName = winner === 'player1' ? 
                    (this.mode === 'online' ? this.multiplayer.playerName : 'JUGADOR 1') : 
                    (this.mode === 'ai' ? 'M√ÅQUINA' : 
                     this.mode === 'online' ? this.multiplayer.opponentName : 'JUGADOR 2');
                const winnerScore = winner === 'player1' ? this.player1.score : this.player2.score;
                
                document.getElementById('gameOverTitle').textContent = 
                    winner === 'player1' ? 'üéâ ¬°VICTORIA!' : 'üí• DERROTA';
                document.getElementById('gameOverMessage').textContent = 
                    `¬°${winnerName} GANA!`;
                document.getElementById('finalScore').textContent = 
                    `Puntuaci√≥n: ${winnerScore} | Tiempo: ${this.timer}s | Nivel: ${this.level}`;
                
                this.saveScore(winnerName, winnerScore, this.timer, this.level);
                
                document.getElementById('hud').classList.remove('active');
                document.getElementById('gameOverScreen').classList.add('active');
            },

            restart() {
                document.getElementById('gameOverScreen').classList.remove('active');
                if (this.mode === 'ai') {
                    document.getElementById('difficultyScreen').classList.add('active');
                } else if (this.mode === 'online') {
                    document.getElementById('onlineScreen').classList.add('active');
                } else {
                    this.startGame(null);
                }
            },

            backToMenu() {
                this.state = 'menu';
                clearInterval(this.timerInterval);
                
                if (this.mode === 'online') {
                    this.multiplayer.cleanup();
                }
                
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('menuScreen').classList.add('active');
                document.getElementById('hud').classList.remove('active');
                document.getElementById('mobileControls').classList.remove('active');
                
                // Reset joystick
                this.joystick.active = false;
                this.joystick.x = 0;
                this.joystick.y = 0;
                
                // Reset formularios
                document.getElementById('hostName').value = '';
                document.getElementById('playerName').value = '';
                document.getElementById('roomCodeInput').value = '';
                document.getElementById('createRoomBtn').disabled = false;
                document.getElementById('joinRoomBtn').disabled = false;
            },

            saveScore(name, score, time, level) {
                const entry = { name, score, time, level, date: new Date().toLocaleDateString() };
                this.leaderboard.push(entry);
                this.leaderboard.sort((a, b) => b.score - a.score);
                this.leaderboard = this.leaderboard.slice(0, 5);
                localStorage.setItem('spaceGameLeaderboard', JSON.stringify(this.leaderboard));
                this.updateLeaderboardDisplay();
            },

            loadLeaderboard() {
                const saved = localStorage.getItem('spaceGameLeaderboard');
                this.leaderboard = saved ? JSON.parse(saved) : [];
            },

            updateLeaderboardDisplay() {
                const container = document.getElementById('leaderboard');
                if (this.leaderboard.length === 0) {
                    container.innerHTML = '<h3>üèÜ TOP 5 PUNTAJES</h3><p style="color: #888;">No hay puntajes registrados</p>';
                } else {
                    let html = '<h3>üèÜ TOP 5 PUNTAJES</h3>';
                    this.leaderboard.forEach((entry, i) => {
                        html += `
                            <div class="leaderboard-entry">
                                <span>${i + 1}. ${entry.name}</span>
                                <span>${entry.score} pts - Nv.${entry.level}</span>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            }
        };

        game.init();
    </script>
</body>
</html>
